---
title: Add a method
description: This guide will show you how to add a new method to the pipeline.
order: 40
engine: knitr
page-navigation: true
---



import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

export const quartoRawHtml =
[`<!-- ```{r, include=FALSE, eval=TRUE}
# set eval to TRUE to make sure is always run, even when profile is not 'evaluate_code'
norm_methods <- list.files("src/datasets/normalization")
norm_methods_str <- paste(paste0("`", norm_methods, "`"), collapse = ", ")
``` -->`,`<details>`,`<summary>`,`</summary>`,`</details>`,`<details>`,`<summary>`,`</summary>`,`</details>`,`<details>`,`<summary>`,`</summary>`,`</details>`,`<details>`,`<summary>`,`</summary>`,`</details>`,`<details>`,`<summary>`,`</summary>`,`</details>`,`<details>`,`<summary>`,`</summary>`,`</details>`];

A method is a technique to solve a specific problem when analysing omics
data. Its performance is assessed by comparing it to other methods and
control methods.

This guide will show you how to create a new [Viash](https://viash.io)
component. In the following we will show examples for both Python and R.
Note that the Task template repo is used throughout the guide, so make
sure to replace any occurrences of `"task_template"` with your task of
interest.

:::tip

Make sure you have followed the [“Getting started”](getting_started.qmd)
guide.

:::

## Step 1: Create a new component

Use the `create_*_method.sh` script found in the scripts repository to
start creating a new method. Open the script and update the `name`
parameter to the desired name of the method.

<Tabs groupId="language">
<TabItem value="Python">

```bash
scripts/create_component/create_python_method.sh
```

``` text
[notice] Checking if Docker image is available at 'ghcr.io/openproblems-bio/core/project/create_component:build_main'
Check inputs
Check language
Check API file
Read API file
Create output dir
Create config
Create script
Done!
```

```bash title="scripts/create_component/create_python_method.sh"
common/scripts/create_component \
  --name my_python_method \
  --language python \
  --type method
```

This creates a new folder at `src/methods/my_python_method` containing a
Viash config and a script.

``` text
tree src/methods/my_python_method
    ├── script.py         Script for running the method.
    ├── config.vsh.yaml   Config file for method.
    └── ...               Optional additional resources.
```

</TabItem>
<TabItem value="R">

```bash
scripts/create_component/create_r_method.sh
```

``` text
Check inputs
Check language
Check API file
Read API file
Create output dir
Create config
Create script
Done!
```

```bash title="scripts/create_component/create_r_method.sh"
common/scripts/create_component \
  --name my_r_method \
  --language r \
  --type method
```

This creates a new folder at `src/methods/my_r_method` containing a
Viash config and a script.

``` text
tree src/methods/my_r_method
    ├── script.R          Script for running the method.
    ├── config.vsh.yaml   Config file for method.
    └── ...               Optional additional resources.
```

</TabItem>
</Tabs>

Change the `--name` to a unique name for your method. It must match the
regex `[a-z][a-z0-9_]*` (snakecase).

-   A **config file** contains metadata of the component and the
    dependencies required to run it. In steps 2 and 3 we will fill in
    the required information.
-   A **script** contains the code to run the method. In step 4 we will
    edit the script.

:::tip

Some tasks have multiple method subtypes (e.g. `batch_integration`),
which will require you to use a different value for `--type`
corresponding to the desired method subtype.

:::

## Step 2: Fill in metadata

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[0] }} />

The [Viash config](https://viash.io/reference/config/) contains metadata
of your method, which script is used to run it, and the required
dependencies.

### Generated config file

This is what the `config.vsh.yaml` generated by the `create_component`
component looks like:

<Tabs groupId="language">
<TabItem value="Python">
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[1] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[2] }} />

Contents of `config.vsh.yaml`
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[3] }} />


```yaml
# The API specifies which type of component this is.
# It contains specifications for:
#   - The input/output files
#   - Common parameters
#   - A unit test
__merge__: ../../api/comp_method.yaml

# A unique identifier for your component (required).
# Can contain only lowercase letters or underscores.
name: my_python_method
# A relatively short label, used when rendering visualisations (required)
label: My Python Method
# A one sentence summary of how this method works (required). Used when 
# rendering summary tables.
summary: "FILL IN: A one sentence summary of this method."
# A multi-line description of how this component works (required). Used
# when rendering reference documentation.
description: |
  FILL IN: A (multi-line) description of how this method works.
# references:
#   doi: 
#     - 10.1000/xx.123456.789
#   bibtex:
#     - |
#       @article{foo,
#         title={Foo},
#         author={Bar},
#         journal={Baz},
#         year={2024}
#       }
links:
  # URL to the documentation for this method (required).
  documentation: https://url.to/the/documentation
  # URL to the code repository for this method (required).
  repository: https://github.com/organisation/repository



# Metadata for your component
info:
  # Which normalisation method this component prefers to use (required).
  preferred_normalization: log_cp10k

# Component-specific parameters (optional)
# arguments:
#   - name: "--n_neighbors"
#     type: "integer"
#     default: 5
#     description: Number of neighbors to use.

# Resources required to run the component
resources:
  # The script of your component (required)
  - type: python_script
    path: script.py
  # Additional resources your script needs (optional)
  # - type: file
  #   path: weights.pt

engines:
  # Specifications for the Docker image for this component.
  - type: docker
    image: openproblems/base_python:1.0.0
    # Add custom dependencies here (optional). For more information, see
    # https://viash.io/reference/config/engines/docker/#setup .
    # setup:
    #   - type: python
    #     packages: numpy<2

runners:
  # This platform allows running the component natively
  - type: executable
  # Allows turning the component into a Nextflow module / pipeline.
  - type: nextflow
    directives:
      label: [midtime,midmem,midcpu]
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[4] }} />

</TabItem>
<TabItem value="R">
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[5] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[6] }} />

Contents of `config.vsh.yaml`
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[7] }} />


```yaml
# The API specifies which type of component this is.
# It contains specifications for:
#   - The input/output files
#   - Common parameters
#   - A unit test
__merge__: ../../api/comp_method.yaml

# A unique identifier for your component (required).
# Can contain only lowercase letters or underscores.
name: my_r_method
# A relatively short label, used when rendering visualisations (required)
label: My R Method
# A one sentence summary of how this method works (required). Used when 
# rendering summary tables.
summary: "FILL IN: A one sentence summary of this method."
# A multi-line description of how this component works (required). Used
# when rendering reference documentation.
description: |
  FILL IN: A (multi-line) description of how this method works.
# references:
#   doi: 
#     - 10.1000/xx.123456.789
#   bibtex:
#     - |
#       @article{foo,
#         title={Foo},
#         author={Bar},
#         journal={Baz},
#         year={2024}
#       }
links:
  # URL to the documentation for this method (required).
  documentation: https://url.to/the/documentation
  # URL to the code repository for this method (required).
  repository: https://github.com/organisation/repository



# Metadata for your component
info:
  # Which normalisation method this component prefers to use (required).
  preferred_normalization: log_cp10k

# Component-specific parameters (optional)
# arguments:
#   - name: "--n_neighbors"
#     type: "integer"
#     default: 5
#     description: Number of neighbors to use.

# Resources required to run the component
resources:
  # The script of your component (required)
  - type: r_script
    path: script.R
  # Additional resources your script needs (optional)
  # - type: file
  #   path: weights.pt

engines:
  # Specifications for the Docker image for this component.
  - type: docker
    image: openproblems/base_r:1.0.0
    # Add custom dependencies here (optional). For more information, see
    # https://viash.io/reference/config/engines/docker/#setup .
    # setup:
    #   - type: r
    #     packages: tibble

runners:
  # This platform allows running the component natively
  - type: executable
  # Allows turning the component into a Nextflow module / pipeline.
  - type: nextflow
    directives:
      label: [midtime,midmem,midcpu]
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[8] }} />

</TabItem>
</Tabs>

### Required metadata fields

Please edit `info` section in the config file to fill in the necessary
metadata.

-   **`.__merge__`**: The API specifies which type of component this is.
    It contains specifications for:

    -   The input/output files
    -   Common parameters
    -   A unit test

-   **`.name`**: A unique identifier. Can only contain lowercase
    letters, numbers or underscores.

-   **`.label`**: A unique, human-readable, short label. Used for
    creating summary tables and visualisations.

-   **`.summary`**: A one sentence summary of purpose and methodology.
    Used for creating an overview tables.

-   **`.description`**: A longer description (one or more paragraphs).
    Used for creating reference documentation and supplementary
    information.

## Step 3: Add dependencies

Each component has it’s own set of dependencies, because different
components might have conflicting dependencies.

## base images

For your convenience we have created several base images that can be
used for python or R scripts. These images can be found in the
[OpenProblems Docker repository](https://hub.docker.com/r/openproblems).
Click on the packages to view the url you need to use. You are not
required to use these images but install the required packages to make
sure OpenProblems works properly.

-   `openproblems/base_python` Base image for python scripts.

-   `openproblems/base_r` Base image for R scripts.

-   `openproblems/base_pytorch_nvidia` Base image for scripts that use
    pytorch with nvidia gpu support.

-   `openproblems/base_tensorflow_nvidia` Base image for scripts that
    use tensorflow with nvidia gpu support.

## custom image

Update the `setup` definition in the `platforms` section of the config
file. This section describes the packages that need to be installed in
the Docker image and are required for your method to run.

If you’re using a custom image use the following minimum setup:

<Tabs>
<TabItem value="Python">

```yaml
platforms:
  - type: docker
    Image: your custom image
    setup:
      - type: apt
        packages:
          - procps
      - type: python
        packages:
          - anndata~=0.10.0
          - scanpy~=1.10.0
          - pyyaml
          - requests
          - jsonschema
        github: 
          - "openproblems-bio/core#subdirectory=packages/python/openproblems"
```

</TabItem>
<TabItem value="R">

```yaml
platforms:
  - type: docker
    Image: your custom image
    setup:
      - type: apt
        packages:
          - procps
          - libhdf5-dev
          - libgeos-dev
          - python3
          - python3-pip
          - python3-dev
          - python-is-python3
      - type: python
        packages:
          - rpy2
          - anndata~=0.10.0
          - scanpy~=1.10.0
          - pyyaml
          - requests
          - jsonschema
        github: 
          - "openproblems-bio/core#subdirectory=packages/python/openproblems"
      - type: r
        packages:
          - anndata
          - BiocManager
          - reticulate
          - bit64
        github:
          - openproblems-bio/core/packages/r/openproblems
```

</TabItem>
</Tabs>

Please check out this
[guide](https://viash.io/guide/component/add-dependencies.html) for more
information on how to add extra package dependencies.

:::note

**Tip:** After making changes to the components dependencies, you will
need to rebuild the docker container as follows:

```bash
viash run src/methods/my_python_method/config.vsh.yaml -- \
  ---setup cachedbuild
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[9] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[10] }} />

output
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[11] }} />

``` text
[notice] Building container 'ghcr.io/openproblems-bio/task_template/methods/my_python_method:dev' with Dockerfile
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[12] }} />

:::

## Step 4: Edit script

A component’s script typically has five sections:

1.  Imports and libraries
2.  Argument values
3.  Read input data
4.  Generate results
5.  Write output data to file

This is what the script generated by the `create_component` component
looks like:

<Tabs groupId="language">
<TabItem value="Python">
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[13] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[14] }} />

Contents of `script.py`
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[15] }} />


```python
import anndata as ad

## VIASH START
# Note: this section is auto-generated by viash at runtime. To edit it, make changes
# in config.vsh.yaml and then run `viash config inject config.vsh.yaml`.
par = {
  'input_train': 'resources_test/.../train.h5ad',
  'input_test': 'resources_test/.../test.h5ad',
  'output': 'output.h5ad'
}
meta = {
  'name': 'my_python_method'
}
## VIASH END

print('Reading input files', flush=True)
input_train = ad.read_h5ad(par['input_train'])
input_test = ad.read_h5ad(par['input_test'])

print('Preprocess data', flush=True)
# ... preprocessing ...

print('Train model', flush=True)
# ... train model ...

print('Generate predictions', flush=True)
# ... generate predictions ...

print("Write output AnnData to file", flush=True)
output = ad.AnnData(
  
)
output.write_h5ad(par['output'], compression='gzip')
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[16] }} />

</TabItem>
<TabItem value="R">
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[17] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[18] }} />

Contents of `script.R`
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[19] }} />


```r
library(anndata)

## VIASH START
par <- list(
  input_train = "resources_test/.../train.h5ad",
  input_test = "resources_test/.../test.h5ad",
  output = "output.h5ad"
)
meta <- list(
  name = "my_r_method"
)
## VIASH END

cat("Reading input files\n")
input_train <- anndata::read_h5ad(par[["input_train"]])
input_test <- anndata::read_h5ad(par[["input_test"]])

cat("Preprocess data\n")
# ... preprocessing ...

cat("Train model\n")
# ... train model ...

cat("Generate predictions\n")
# ... generate predictions ...

cat("Write output AnnData to file\n")
output <- anndata::AnnData(
  
)
output$write_h5ad(par[["output"]], compression = "gzip")
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[20] }} />

</TabItem>
</Tabs>

The required sections are explained here in more detail:

### a. Imports and libraries {#a.-imports-and-libraries}

In the top section of the script you can define which packages/libraries
the method needs. If you add a new or different package add the
dependency to `config.vsh.yaml` in the `setup` field (see above).

### b. Argument block {#b.-argument-block}

The [Viash code block](https://viash.io/reference/viash_code_block/) is
designed to facilitate prototyping, by enabling you to execute directly
by running `python script.py` (or `Rscript script.R` for R users). Note
that anything between “VIASH START” and “VIASH END” will be removed and
replaced with a CLI argument parser when the components are being built
by Viash.

Here, the `par` dictionary contains all the `arguments` defined in the
`config.vsh.yaml` file (including those from the defined `__merge__`
file). When adding a `argument` in the `par` dict **also** add it to the
`config.vsh.yaml` in the `arguments` section.

### c. Read input data {#c.-read-input-data}

This section reads any input AnnData files passed to the component.

### d. Generate results {#d.-generate-results}

This is the most important section of your script, as it defines the
core functionality provided by the component. It processes the input
data to create results for the particular task at hand.

### e. Write output data to file {#e.-write-output-data-to-file}

The output stored in a AnnData object and then written to an `.h5ad`
file. The format is specified by the API file specified in the
`__merge__` field in the config file.

## Step 5: Add resources (optional)

It is possible to add additional resources such as a file containing
helper functions or other resources. Please visit [this
page](https://viash.io/guide/component/use-helper-functions.html) for
more information on how to do this.

## Step 6: Try component

Your component’s API file contains the necessary unit tests to check
whether your component works and the output is in the correct format.

You can test your component by using the following command:

```bash
viash test src/methods/my_python_method/config.vsh.yaml
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[21] }} />

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[22] }} />

Output
<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[23] }} />

``` text
Running tests in temporary directory: '/tmp/viash_test_logistic_regression_17410533509347319749'
====================================================================
+/tmp/viash_test_logistic_regression_17410533509347319749/build_engine_environment/logistic_regression ---verbosity 6 ---setup cachedbuild ---engine docker
[notice] Building container 'ghcr.io/openproblems-bio/task_template/methods/logistic_regression:test' with Dockerfile
[info] docker build -t 'ghcr.io/openproblems-bio/task_template/methods/logistic_regression:test'  '/tmp/viash_test_logistic_regression_17410533509347319749/build_engine_environment' -f '/tmp/viash_test_logistic_regression_17410533509347319749/build_engine_environment/tmp/dockerbuild-logistic_regression-LkLO4K/Dockerfile'
#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 571B done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/openproblems/base_python:1.0.0
#2 DONE 0.1s

#3 [internal] load .dockerignore
#3 transferring context: 2B done
#3 DONE 0.0s

#4 [1/2] FROM docker.io/openproblems/base_python:1.0.0@sha256:8f412fb68458fe21f891eee39cc7c92862f3a72542abb3d760d5d3b8585808b6
#4 CACHED

#5 [2/2] RUN pip install --upgrade pip &&   pip install --upgrade --no-cache-dir "scikit-learn"
#5 0.466 Requirement already satisfied: pip in /usr/local/lib/python3.11/site-packages (24.3.1)
#5 0.649 WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable.It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.
#5 1.050 Requirement already satisfied: scikit-learn in /usr/local/lib/python3.11/site-packages (1.6.0)
#5 1.223 Requirement already satisfied: numpy>=1.19.5 in /usr/local/lib/python3.11/site-packages (from scikit-learn) (2.0.2)
#5 1.224 Requirement already satisfied: scipy>=1.6.0 in /usr/local/lib/python3.11/site-packages (from scikit-learn) (1.14.1)
#5 1.224 Requirement already satisfied: joblib>=1.2.0 in /usr/local/lib/python3.11/site-packages (from scikit-learn) (1.4.2)
#5 1.225 Requirement already satisfied: threadpoolctl>=3.1.0 in /usr/local/lib/python3.11/site-packages (from scikit-learn) (3.5.0)
#5 1.302 WARNING: Running pip as the 'root' user can result in broken permissions and conflicting behaviour with the system package manager, possibly rendering your system unusable.It is recommended to use a virtual environment instead: https://pip.pypa.io/warnings/venv. Use the --root-user-action option if you know what you are doing and want to suppress this warning.
#5 DONE 1.5s

#6 exporting to image
#6 exporting layers
#6 exporting layers 2.0s done
#6 writing image sha256:cbb252eab5141301825dde772ee1cfc3152957b814493cd59cd02cd9f6c2c274 done
#6 naming to ghcr.io/openproblems-bio/task_template/methods/logistic_regression:test done
#6 DONE 2.0s
====================================================================
+/tmp/viash_test_logistic_regression_17410533509347319749/test_run_and_check_output/test_executable
>> Running test 'run'
>> Checking whether input files exist
>> Running script as test
Reading input files
Preprocess data
Train model
Generate predictions
Write output AnnData to file
>> Checking whether output file exists
>> Reading h5ad files and checking formats
Reading and checking output
  AnnData object with n_obs × n_vars = 123 × 0
    obs: 'label_pred'
    uns: 'dataset_id', 'method_id', 'normalization_id'
All checks succeeded!
====================================================================
+/tmp/viash_test_logistic_regression_17410533509347319749/test_check_config/test_executable
Load config data
Check .namespace
Check .info.type
Check component metadata
Check references fields
Checking contents of .info.preferred_normalization
Check Nextflow runner
All checks succeeded!
====================================================================
SUCCESS! All 2 out of 2 test scripts succeeded!
Cleaning up temporary directory
```

<div dangerouslySetInnerHTML={{ __html: quartoRawHtml[24] }} />

Visit [“Run tests”](run_tests.qmd) for more information on running unit
tests and how to interpret common error messages.

You can also run your component on local files using the `viash run`
command. For example:

```bash
viash run src/methods/my_python_method/config.vsh.yaml -- \
  --input_train resources_test/task_template/cxg_mouse_pancreas_atlas/train.h5ad \
  --input_test resources_test/task_template/cxg_mouse_pancreas_atlas/test.h5ad \
  --output output.h5ad
```

## Next steps

If your component works, please [create a pull
request](../create_component/create_pull_request.qmd).
